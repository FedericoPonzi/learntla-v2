<?xml version="1.0"?>
<root folder="threads">
<spec name="threads" num="3">
---- MODULE $name ----
EXTENDS TLC, Sequences, Integers<s on="3-">
CONSTANT NULL</s>

NumThreads == 2
Threads == 1..NumThreads

(* --algorithm threads

variables 
  counter = 0;<s on="3">
  lock = NULL;</s>

define
  AllDone == 
    \A t \in Threads: pc[t] = "Done"

  Correct ==
      AllDone => counter = NumThreads
end define;  

process thread \in Threads<s on="2-">
variables tmp = 0;</s>
begin<s on="2-"><s on="3">
  GetLock:
    await lock = NULL;
    lock := self;
</s>
  GetCounter:
    tmp := counter;
</s>
  IncCounter:
    counter := <s on="1">counter</s><s on="2-">tmp</s> + 1;<s on="3">
  
  ReleaseLock:
    lock := NULL; </s>
end process;
end algorithm; *)
====
</spec>

<spec name="threads_action_props" num="7"> 
    <s><s><s>TODO move this to a different file?
---- MODULE $name ----
EXTENDS TLC, Sequences, Integers
CONSTANT NULL

NumThreads == 2
Threads == 1..NumThreads

(* --algorithm threads

variables 
  counter = 0;
  lock = NULL;

define <s on="2-">  
  CounterOnlyIncreases ==
    [][counter' >= counter]_counter</s><s on="4-">

  LockCantBeStolen ==
    [][lock # NULL => lock' = NULL]_lock</s><s on="6-">

  LockNullBeforeAcquired ==
    [][lock' # NULL => lock = NULL]_lock</s>
end define;  

process thread \in Threads
variables tmp = 0;
begin
  GetLock:
    <s on="-4">await lock = NULL;</s>
    lock := self;

  GetCounter:
    tmp := counter;

  IncCounter:
    counter := tmp + <s on="3"> IF tmp = 0 THEN 1 ELSE -</s>1;
  
  ReleaseLock:
    lock := NULL; 
end process;
end algorithm; *)
====

</spec>
</root>


